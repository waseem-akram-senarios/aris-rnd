name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger from GitHub UI

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_DIR: ${{ secrets.SERVER_DIR }}

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PEM_KEY }}" > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Setup rsync
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq rsync
    
    - name: Deploy to server
      run: |
        # Step 1: Sync code using rsync (no Git auth needed)
        echo "ğŸ”„ Step 1: Syncing code to server (rsync)..."
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='*.log' \
          --exclude='vectorstore' \
          --exclude='data' \
          --exclude='samples' \
          --exclude='tests' \
          --exclude='.env' \
          --exclude='*.pem' \
          --exclude='*.key' \
          --exclude='.vscode' \
          --exclude='.idea' \
          --exclude='*.swp' \
          --exclude='*.swo' \
          --exclude='.DS_Store' \
          --exclude='Thumbs.db' \
          --exclude='emails' \
          --exclude='diagrams' \
          --exclude='docs' \
          --exclude='*.md' \
          -e "ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
          ./ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.SERVER_DIR }}/
        echo "   âœ… Code synced"
        
        # Step 2: Deploy on server
        ssh -i ~/.ssh/deploy_key.pem \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'DEPLOY_SCRIPT'
        set -e
        
        cd /opt/aris-rag
        
        echo ""
        echo "ğŸ” Step 2: Ensuring .env file exists..."
        if [ ! -f ".env" ]; then
          echo "   âš ï¸  .env file not found - create manually if needed"
        else
          echo "   âœ… .env file exists"
        fi
        
        echo ""
        echo "ğŸ³ Step 3: Building Docker image..."
        # Stop and remove old container
        sudo docker stop aris-rag-app 2>/dev/null || true
        sudo docker rm aris-rag-app 2>/dev/null || true
        
        # Build new image
        sudo docker build -t aris-rag:latest . || {
          echo "   âŒ Docker build failed"
          exit 1
        }
        echo "   âœ… Image built successfully"
        
        echo ""
        echo "ğŸš€ Step 4: Starting container..."
        # Start new container with resource limits
        sudo docker run -d \
          --name aris-rag-app \
          --restart unless-stopped \
          -p 80:8501 \
          --cpus="7" \
          --memory="12g" \
          --memory-reservation="8g" \
          -v $(pwd)/vectorstore:/app/vectorstore \
          -v $(pwd)/data:/app/data \
          -v $(pwd)/.env:/app/.env:ro \
          --env-file .env \
          --health-cmd="python -c 'import requests; requests.get(\"http://localhost:8501/_stcore/health\")'" \
          --health-interval=30s \
          --health-timeout=10s \
          --health-retries=3 \
          --health-start-period=40s \
          aris-rag:latest || {
          echo "   âŒ Container start failed"
          exit 1
        }
        echo "   âœ… Container started"
        
        echo ""
        echo "â³ Step 5: Waiting for health check..."
        sleep 15
        
        echo ""
        echo "ğŸ¥ Step 6: Verifying deployment..."
        HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' http://localhost/ || echo "000")
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "   âœ… Deployment successful! HTTP $HTTP_CODE"
          echo "   ğŸŒ Application is live"
        else
          echo "   âš ï¸  Deployment completed but HTTP status: $HTTP_CODE"
          echo "   Checking container logs..."
          sudo docker logs --tail 30 aris-rag-app
          exit 1
        fi
DEPLOY_SCRIPT
    
    - name: Deployment success
      if: success()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… Deployment Successful!             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸŒ Application URL: http://${{ secrets.SERVER_IP }}/"
    
    - name: Deployment failed
      if: failure()
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âŒ Deployment Failed                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Check the logs above for details."

