flowchart TD
    Start["User Uploads File"] --> Validate["Validate File"]
    Validate --> Init["Initialize RAG System<br/>if needed"]
    
    Init --> Parse["Step 1: Parse Document<br/>0-50% Progress"]
    Parse --> ParserSelect{"Select Parser"}
    
    ParserSelect -->|Auto| TryPyMuPDF["Try PyMuPDF"]
    ParserSelect -->|PyMuPDF| TryPyMuPDF
    ParserSelect -->|Docling| TryDocling["Try Docling<br/>Structured parsing"]
    ParserSelect -->|Textract| TryTextract["Try Textract OCR"]
    
    TryPyMuPDF --> CheckExtraction{"Extraction<br/>Quality?"}
    CheckExtraction -->|Good| ParsedDoc["ParsedDocument<br/>text<br/>metadata<br/>pages<br/>confidence"]
    CheckExtraction -->|Poor| TryDocling
    
    TryDocling --> CheckDocling{"Docling<br/>Better?"}
    CheckDocling -->|Yes| ParsedDoc
    CheckDocling -->|No/Timeout| TryTextract
    
    TryTextract --> ParsedDoc
    
    ParsedDoc --> ValidateText{"Text Empty?"}
    ValidateText -->|Yes| Error["Error: Scanned PDF<br/>Suggest Textract/OCR"]
    ValidateText -->|No| Chunk["Step 2: Token-aware Chunking<br/>50% Progress"]
    
    Chunk --> TokenCount["Count Tokens per Chunk<br/>TokenTextSplitter"]
    TokenCount --> CreateChunks["Create Document Chunks<br/>384 tokens/chunk<br/>75 tokens overlap"]
    
    CreateChunks --> Embed["Step 3: Create Embeddings<br/>50-90% Progress"]
    Embed --> Store["Step 4: Store in FAISS<br/>90-100% Progress"]
    
    Store --> TrackMetrics["Track Metrics<br/>Chunks created<br/>Tokens extracted<br/>Processing time"]
    TrackMetrics --> RecordTokenStats["Record Token Statistics<br/>Total tokens<br/>Tokens per chunk<br/>Distribution"]
    
    RecordTokenStats --> Complete["✅ Processing Complete"]
    Error --> End["❌ Processing Failed"]
    Complete --> End
    
    style Parse fill:#e3f2fd
    style Chunk fill:#fff9c4
    style TokenCount fill:#fff9c4
    style Embed fill:#e8f5e9
    style Store fill:#c8e6c9
    style TrackMetrics fill:#f3e5f5
    style RecordTokenStats fill:#f3e5f5



