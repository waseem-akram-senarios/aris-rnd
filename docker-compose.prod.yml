version: '3.8'

services:
  aris-rag:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aris-rag-app
    restart: unless-stopped
    
    # Port mappings matching deploy-fast.sh configuration
    # Port 80 -> Streamlit (8501), Port 8500 -> FastAPI (8000)
    ports:
      - "80:8501"      # Streamlit on port 80
      - "8500:8000"    # FastAPI on port 8500
    
    # Resource limits (adjust based on your AWS EC2 instance size)
    # These are conservative defaults - adjust based on your instance specs
    # For 16 CPU / 61 GB server: use deploy-fast.sh for dynamic allocation
    # Note: For docker-compose (not swarm), resource limits are set via docker run
    # For AWS EC2, use deploy-fast.sh which automatically detects and sets limits
    # If using docker-compose, uncomment and adjust based on your instance:
    # cpus: '15'           # Adjust: your_instance_cpus - 1
    # mem_limit: 59g      # Adjust: your_instance_ram - 2GB
    # mem_reservation: 55g
    
    # Environment variables from .env file
    env_file:
      - .env
    environment:
      # OpenAI API (required)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Cerebras API (optional)
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY:-}
      # AWS Credentials (optional, for Textract)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # OpenSearch Credentials (optional)
      - AWS_OPENSEARCH_ACCESS_KEY_ID=${AWS_OPENSEARCH_ACCESS_KEY_ID:-}
      - AWS_OPENSEARCH_SECRET_ACCESS_KEY=${AWS_OPENSEARCH_SECRET_ACCESS_KEY:-}
      - AWS_OPENSEARCH_REGION=${AWS_OPENSEARCH_REGION:-us-east-2}
    
    # Volume mounts for data persistence
    volumes:
      # Persist vectorstore data
      - ./vectorstore:/app/vectorstore
      # Mount data directory for documents
      - ./data:/app/data
      # Mount .env file (read-only)
      - ./.env:/app/.env:ro
    
    # Health check configuration
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8501/_stcore/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

